#!/bin/bash
#
# This script collects rating data from the AoE2.net API and
# constructs an histogram of the data - through the use of
# the accompanying `histogram.awk` script.
# The output is written to stdin in JSON format.
# It expects a single argument: the bin width to be passed to `histogram.awk`.
#
# Usage
# -----
# $ ./wololo 50 > random-map.json
# 
# References
# ----------
# <https://mywiki.wooledge.org/BashFAQ/028>: accessing bundled files
# <https://stackoverflow.com/q/11003418>: bash function with xargs


cd "${BASH_SOURCE%/*}/" || exit

api () {
  curl -s 'https://aoe2.net/api/leaderboard?game=aoe2de&leaderboard_id=3&start='"$1"'&count='"$2"
}

export -f api

seq 1 1000 "$(api 1 1 | jq '.total')" \
  | xargs -P 10 -I {} bash -c "api {} 1000 | jq '.leaderboard | .[] | .rating'" \
  | tee 'raw.txt' \
  | ./histogram.awk -v bin="$1" \
  | jq --slurp --compact-output --arg bin "$1" '
    {
      histogram: {
        binSize: $bin | tonumber,
        freqs: [.[]]
      },
      date: now | todate
    }'
